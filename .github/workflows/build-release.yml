name: Build and Release

on:
  push:
    tags: ['v*.*.*', 'v*.*.*-*']
  workflow_dispatch:
    inputs:
      version:
        description: 'ÂèëÂ∏ÉÁâàÊú¨Âè∑'
        required: true
        default: '2.0.0'
      prerelease:
        description: 'ÊòØÂê¶‰∏∫È¢ÑÂèëÂ∏ÉÁâàÊú¨'
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'
  PROJECT_NAME: 'Performai-Config-Editor'
  
jobs:
  locate-project:
    name: Locate Project Files
    runs-on: windows-latest
    outputs:
      project_path: ${{ steps.find-project.outputs.project_path }}
      project_name: ${{ steps.find-project.outputs.project_name }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Find project file
      id: find-project
      run: |
        echo "Êü•ÊâæÈ°πÁõÆÊñá‰ª∂..."
        
        # Êü•ÊâæÊâÄÊúâ.csprojÊñá‰ª∂
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        
        if ($csprojFiles.Count -eq 0) {
          echo "ÈîôËØØ: Êú™ÊâæÂà∞.csprojÊñá‰ª∂"
          exit 1
        }
        
        # ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊâæÂà∞ÁöÑÈ°πÁõÆÊñá‰ª∂
        $projectFile = $csprojFiles[0]
        $relativePath = $projectFile.FullName.Substring($PWD.Path.Length + 1)
        
        echo "ÊâæÂà∞È°πÁõÆÊñá‰ª∂: $($projectFile.Name)"
        echo "ÂÆåÊï¥Ë∑ØÂæÑ: $($projectFile.FullName)"
        echo "Áõ∏ÂØπË∑ØÂæÑ: $relativePath"
        
        # ÊèêÂèñÈ°πÁõÆÂêçÁß∞Ôºà‰∏çÂ∏¶Êâ©Â±ïÂêçÔºâ
        $projectName = $projectFile.BaseName
        
        echo "project_path=$relativePath" >> $GITHUB_OUTPUT
        echo "project_name=$projectName" >> $GITHUB_OUTPUT
        
        echo "PROJECT_PATH=$relativePath" >> $env:GITHUB_ENV
        echo "PROJECT_NAME=$projectName" >> $env:GITHUB_ENV
        
  build:
    name: Build Application
    runs-on: windows-latest
    needs: locate-project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Display project info
      run: |
        echo "È°πÁõÆË∑ØÂæÑ: ${{ needs.locate-project.outputs.project_path }}"
        echo "È°πÁõÆÂêçÁß∞: ${{ needs.locate-project.outputs.project_name }}"
        
    - name: Auto format code
      run: |
        echo "Ê†ºÂºèÂåñ‰ª£Á†Å..."
        dotnet format --verbosity minimal
        echo "‚úÖ ‰ª£Á†ÅÊ†ºÂºèÂåñÂÆåÊàê"
        
    - name: Determine Version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        
        VERSION=$(echo $VERSION | sed 's/^v//')
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        echo "ÊûÑÂª∫ÁâàÊú¨: $VERSION"
        
    - name: Restore dependencies
      run: |
        echo "ÊÅ¢Â§ç‰æùËµñ..."
        dotnet restore "${{ needs.locate-project.outputs.project_path }}"
        
    - name: Build application
      run: |
        echo "ÊûÑÂª∫Â∫îÁî®Á®ãÂ∫è..."
        dotnet build "${{ needs.locate-project.outputs.project_path }}" `
          --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          --no-restore
        
        echo "‚úÖ ÊûÑÂª∫ÊàêÂäü"
        
    - name: Publish application
      run: |
        echo "ÂèëÂ∏ÉÂ∫îÁî®Á®ãÂ∫è..."
        
        # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
        $artifactsDir = "./artifacts"
        $outputDir = "$artifactsDir/${{ env.PROJECT_NAME }}"
        
        New-Item -ItemType Directory -Path $outputDir -Force
        
        # ÂèëÂ∏ÉÂ∫îÁî®Á®ãÂ∫è
        dotnet publish "${{ needs.locate-project.outputs.project_path }}" `
          --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          --output $outputDir `
          --no-restore
        
        # ÂàõÂª∫ZIPÂåÖ
        $zipName = "${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip"
        Compress-Archive -Path "$outputDir/*" `
          -DestinationPath "$artifactsDir/$zipName" `
          -Force
        
        echo "‚úÖ ÂèëÂ∏ÉÂÆåÊàê"
        echo "üì¶ ZIPÊñá‰ª∂: $zipName"
        
        # ÊòæÁ§∫ÁîüÊàêÁöÑÊñá‰ª∂‰ø°ÊÅØ
        echo "`n=== ÁîüÊàêÁöÑÊñá‰ª∂ÂàóË°® ==="
        $exeFiles = Get-ChildItem $outputDir -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          echo "ÂèØÊâßË°åÊñá‰ª∂:"
          foreach ($exe in $exeFiles) {
            echo "  - $($exe.Name) ($([math]::Round($exe.Length/1KB, 2)) KB)"
          }
        }
        
        $totalFiles = (Get-ChildItem $outputDir -File -Recurse).Count
        $totalSize = (Get-ChildItem $outputDir -File -Recurse | Measure-Object -Property Length -Sum).Sum
        echo "`nüìä ÂèëÂ∏ÉÂåÖÁªüËÆ°:"
        echo "  Êñá‰ª∂ÊÄªÊï∞: $totalFiles"
        echo "  ÊÄªÂ§ßÂ∞è: $([math]::Round($totalSize/1MB, 2)) MB"
        
    - name: Create release notes
      run: |
        # ÂàõÂª∫ÁÆÄÂçïÁöÑÂèëÂ∏ÉËØ¥Êòé
        $releaseNotes = @"
# ${{ env.PROJECT_NAME }} ${{ env.VERSION }}

## Á≥ªÁªüË¶ÅÊ±Ç
- Windows 10 ÊàñÊõ¥È´òÁâàÊú¨
- [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)

## ÂÆâË£ÖËØ¥Êòé
1. ‰∏ãËΩΩÂπ∂Ëß£Âéã ZIP Êñá‰ª∂
2. ËøêË°å `${{ needs.locate-project.outputs.project_name }}.exe`

## Êñá‰ª∂‰ø°ÊÅØ
- ÊûÑÂª∫Êó∂Èó¥: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- ÊûÑÂª∫ÁºñÂè∑: ${{ github.run_number }}
- È°πÁõÆÂêçÁß∞: ${{ needs.locate-project.outputs.project_name }}

## È™åËØÅ
ÂêØÂä®Á®ãÂ∫èÂêéÔºåÊ£ÄÊü•Áä∂ÊÄÅÊ†èÊòæÁ§∫ÁöÑÁâàÊú¨‰ø°ÊÅØ„ÄÇ

---
*Ëá™Âä®ÊûÑÂª∫‰∫é GitHub Actions*
"@
        
        $releaseNotes | Out-File -FilePath "./artifacts/RELEASE_NOTES.md" -Encoding UTF8
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ./artifacts/
        retention-days: 90
        
  create-release:
    name: Create GitHub Release
    runs-on: windows-latest
    needs: [build]
    if: success()
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./release
        
    - name: Setup release info
      id: release_info
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" == *"-alpha"* || "$TAG_NAME" == *"-beta"* || "$TAG_NAME" == *"-rc"* ]]; then
            PRERELEASE="true"
          else
            PRERELEASE="false"
          fi
        else
          TAG_NAME="v${{ github.event.inputs.version }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"
        fi
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
        
        echo "ÂàõÂª∫ÂèëÂ∏É: $TAG_NAME"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        name: ${{ env.PROJECT_NAME }} ${{ steps.release_info.outputs.tag_name }}
        body_path: ./release/RELEASE_NOTES.md
        prerelease: ${{ steps.release_info.outputs.prerelease == 'true' }}
        draft: false
        files: |
          ./release/${{ env.PROJECT_NAME }}-*.zip
          ./release/RELEASE_NOTES.md
