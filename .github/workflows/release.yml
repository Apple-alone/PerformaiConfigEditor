name: Release v2.0.0

on:
  push:
    tags:
      - 'v2.0.0'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'å‘å¸ƒ v2.0.0'
        type: boolean
        default: false

env:
  VERSION: '2.0.0'
  TAG_NAME: 'v2.0.0'
  PROJECT_NAME: 'Performai-Config-Editor'
  CONFIGURATION: 'Release'

jobs:
  build-and-release:
    name: Build and Release v2.0.0
    runs-on: windows-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    # 2. è®¾ç½® .NET
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    # 3. æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    - name: Display version info
      run: |
        echo "ğŸ‰ å¼€å§‹å‘å¸ƒ v2.0.0"
        echo "ğŸ·ï¸  æ ‡ç­¾: ${{ env.TAG_NAME }}"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ env.VERSION }}"
        echo "ğŸ“… æ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        
    # 4. æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶
    - name: Find project file
      id: find-project
      run: |
        echo "ğŸ” æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶..."
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        
        if ($csprojFiles.Count -eq 0) {
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° .csproj æ–‡ä»¶"
          exit 1
        }
        
        $projectFile = $csprojFiles[0]
        echo "âœ… æ‰¾åˆ°é¡¹ç›®æ–‡ä»¶: $($projectFile.FullName)"
        echo "PROJECT_FILE=$($projectFile.FullName)" >> $env:GITHUB_ENV
        
    # 5. æ¢å¤ä¾èµ–
    - name: Restore dependencies
      run: |
        echo "ğŸ“¦ æ¢å¤ NuGet ä¾èµ–..."
        dotnet restore "$env:PROJECT_FILE"
        
    # 6. æ„å»ºåº”ç”¨
    - name: Build application
      run: |
        echo "ğŸ”¨ æ„å»ºåº”ç”¨ç¨‹åº v2.0.0..."
        dotnet build "$env:PROJECT_FILE" `
          --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          -p:AssemblyVersion=${{ env.VERSION }} `
          --no-restore
        
        if ($LASTEXITCODE -eq 0) {
          echo "âœ… æ„å»ºæˆåŠŸ"
        } else {
          echo "âŒ æ„å»ºå¤±è´¥"
          exit 1
        }
        
    # 7. å‘å¸ƒåº”ç”¨
    - name: Publish application
      run: |
        echo "ğŸš€ å‘å¸ƒåº”ç”¨ç¨‹åº..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        $publishDir = "./publish/${{ env.PROJECT_NAME }}-${{ env.VERSION }}"
        New-Item -ItemType Directory -Path $publishDir -Force
        
        # å‘å¸ƒåº”ç”¨
        dotnet publish "$env:PROJECT_FILE" `
          --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          --output $publishDir `
          --no-restore
        
        if ($LASTEXITCODE -ne 0) {
          echo "âŒ å‘å¸ƒå¤±è´¥"
          exit 1
        }
        
        echo "âœ… å‘å¸ƒæˆåŠŸ"
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        $exeFiles = Get-ChildItem $publishDir -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          echo "ğŸ“„ ç”Ÿæˆçš„æ–‡ä»¶:"
          foreach ($exe in $exeFiles) {
            $sizeMB = [math]::Round($exe.Length/1MB, 2)
            echo "  - $($exe.Name) (${sizeMB} MB)"
          }
        }
        
        $allFiles = Get-ChildItem $publishDir -File -Recurse
        $totalSize = ($allFiles | Measure-Object -Property Length -Sum).Sum
        $totalSizeMB = [math]::Round($totalSize/1MB, 2)
        
        echo "ğŸ“Š ç»Ÿè®¡:"
        echo "  æ–‡ä»¶æ€»æ•°: $($allFiles.Count)"
        echo "  æ€»å¤§å°: ${totalSizeMB} MB"
        
    # 8. åˆ›å»º ZIP åŒ…
    - name: Create ZIP archive
      run: |
        echo "ğŸ“¦ åˆ›å»º ZIP å‹ç¼©åŒ…..."
        
        $publishDir = "./publish/${{ env.PROJECT_NAME }}-${{ env.VERSION }}"
        $zipFile = "./publish/${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip"
        
        if (Test-Path $publishDir) {
          Compress-Archive -Path "$publishDir/*" -DestinationPath $zipFile -Force
          
          $zipInfo = Get-Item $zipFile
          $zipSizeMB = [math]::Round($zipInfo.Length/1MB, 2)
          
          echo "âœ… ZIP åŒ…åˆ›å»ºæˆåŠŸ"
          echo "ğŸ“¦ æ–‡ä»¶: $($zipInfo.Name)"
          echo "ğŸ“ å¤§å°: ${zipSizeMB} MB"
        } else {
          echo "âŒ å‘å¸ƒç›®å½•ä¸å­˜åœ¨"
          exit 1
        }
        
    # 9. ç”Ÿæˆè¯¦ç»†çš„å‘å¸ƒè¯´æ˜
    - name: Generate release notes
      run: |
        echo "ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜..."
        
        $releaseNotes = @"
# ğŸ® Performai Config Editor v2.0.0

## ğŸ‰ é‡è¦æ›´æ–°

**Performai Config Editor 2.0.0** æ˜¯ä¸€ä¸ªé‡å¤§æ›´æ–°ç‰ˆæœ¬ï¼Œå¸¦æ¥äº†å…¨æ–°çš„ç”¨æˆ·ä½“éªŒå’Œå¢å¼ºçš„åŠŸèƒ½ã€‚

## ğŸ“… å‘å¸ƒä¿¡æ¯
- **ç‰ˆæœ¬å·**: 2.0.0
- **å‘å¸ƒæ—¥æœŸ**: $(Get-Date -Format 'yyyyå¹´MMæœˆddæ—¥')
- **æ„å»ºç¼–å·**: ${{ github.run_number }}
- **æ„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

## ğŸš€ æ–°ç‰¹æ€§

### âœ¨ å…¨æ–°åŠŸèƒ½
1. **ç°ä»£åŒ– UI è®¾è®¡** - å…¨æ–°çš„ç•Œé¢è®¾è®¡ï¼Œæ›´ç¾è§‚æ˜“ç”¨
2. **è‡ªå®šä¹‰æ¶ˆæ¯æ¡†** - ç¾è§‚çš„è‡ªå®šä¹‰æç¤ºæ¡†ï¼Œæ›¿ä»£ç³»ç»Ÿé»˜è®¤
3. **æ™ºèƒ½é…ç½®æ£€æµ‹** - è‡ªåŠ¨æ£€æµ‹é…ç½®æ–‡ä»¶ç‰ˆæœ¬å’Œç±»å‹
4. **é«˜çº§ç¼–è¾‘æ¨¡å¼** - æ”¯æŒç›´æ¥ç¼–è¾‘é…ç½®æ–‡ä»¶æºä»£ç 

### ğŸ”§ åŠŸèƒ½å¢å¼º
1. **AIME é…ç½®ç®¡ç†** - å¢å¼ºçš„å¡å·æ–‡ä»¶ç®¡ç†
2. **ç½‘ç»œè®¾ç½®ä¼˜åŒ–** - æ”¯æŒå¤šä¸ªæœåŠ¡å™¨é¢„è®¾
3. **KeyChip é…ç½®** - å®Œå–„çš„ KeyChip ID ç®¡ç†
4. **SDHD/SDDT ä¸“ç”¨è®¾ç½®** - é’ˆå¯¹ä¸åŒç‰ˆæœ¬çš„ä¼˜åŒ–é…ç½®

### ğŸ› ï¸ æŠ€æœ¯æ”¹è¿›
1. **åŸºäº .NET 8.0** - æœ€æ–°çš„ .NET æ¡†æ¶
2. **ç°ä»£åŒ– WPF æ¶æ„** - ä½¿ç”¨æœ€æ–°çš„ WPF æŠ€æœ¯
3. **GitHub Actions é›†æˆ** - è‡ªåŠ¨åŒ–æ„å»ºå’Œå‘å¸ƒ
4. **ä»£ç è´¨é‡ä¿è¯** - å®Œå–„çš„ CI/CD æµç¨‹

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
- **è¿è¡Œæ—¶**: [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)
- **å†…å­˜**: è‡³å°‘ 2GB RAM
- **ç£ç›˜ç©ºé—´**: è‡³å°‘ 100MB å¯ç”¨ç©ºé—´

## ğŸ“¥ å®‰è£…è¯´æ˜

### æ–¹æ³•ä¸€ï¼šå¿«é€Ÿå®‰è£…
1. ä¸‹è½½ **[Performai-Config-Editor-2.0.0.zip](https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip)**
2. è§£å‹åˆ°ä»»æ„ç›®å½•
3. è¿è¡Œ `Performai-Config-Editor.exe`

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨å®‰è£…
1. ç¡®ä¿å·²å®‰è£… .NET 8.0 Desktop Runtime
2. ä¸‹è½½å‘å¸ƒåŒ…å¹¶è§£å‹
3. åŒå‡»è¿è¡Œä¸»ç¨‹åº

## ğŸ” ä¸»è¦åŠŸèƒ½

### 1. AIME è®¾ç½®
- å¯ç”¨/ç¦ç”¨ AIME è™šæ‹Ÿè¯»å¡å™¨
- å¡å·æ–‡ä»¶è·¯å¾„é…ç½®
- å¡å·å†…å®¹ç¼–è¾‘å’Œç®¡ç†

### 2. ç½‘ç»œè®¾ç½®
- DNS æœåŠ¡å™¨é…ç½®
- å¤šæœåŠ¡å™¨é¢„è®¾é€‰æ‹©
- ç½‘ç»œç¯å¢ƒæ¨¡æ‹Ÿ
- AimeDB æœåŠ¡å™¨è®¾ç½®

### 3. KeyChip è®¾ç½®
- KeyChip ID ç®¡ç†
- æ¸¸æˆ ID è‡ªåŠ¨è¯†åˆ«
- å­ç½‘åœ°å€é…ç½®

### 4. ç‰ˆæœ¬ä¸“ç”¨è®¾ç½®
- **SDHD ä¸“ç”¨**: æ§åˆ¶å™¨è®¾ç½®ã€çº¢å¤–ä¼ æ„Ÿå™¨ã€YubiDeck é…ç½®
- **SDDT ä¸“ç”¨**: LED è®¾ç½®ã€Unity é’©å­ã€ä¸²å£é…ç½®

### 5. é«˜çº§åŠŸèƒ½
- æŸ¥çœ‹å’Œç¼–è¾‘é…ç½®æ–‡ä»¶æºä»£ç 
- æ™ºèƒ½é…ç½®å†²çªæ£€æµ‹
- å¡å·æ–‡ä»¶è‡ªåŠ¨åˆ‡æ¢

## ğŸ› å·²çŸ¥é—®é¢˜
- æŸäº›ç‰¹æ®Šå­—ç¬¦åœ¨å¡å·æ–‡ä»¶ä¸­å¯èƒ½æ˜¾ç¤ºå¼‚å¸¸
- é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
- ç½‘ç»œé…ç½®éœ€è¦é‡å¯åº”ç”¨ç”Ÿæ•ˆ

## ğŸ”„ ä» v1.0 å‡çº§
1. å¤‡ä»½ç°æœ‰çš„é…ç½®æ–‡ä»¶
2. ä¸‹è½½å¹¶å®‰è£… v2.0.0
3. å¯¼å…¥ä¹‹å‰çš„é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
4. äº«å—æ–°åŠŸèƒ½ï¼

## ğŸ“ æ”¯æŒä¸åé¦ˆ
- **é—®é¢˜æŠ¥å‘Š**: åœ¨ GitHub Issues ä¸­æäº¤é—®é¢˜
- **åŠŸèƒ½å»ºè®®**: æ¬¢è¿æå‡ºæ”¹è¿›å»ºè®®
- **æ–‡æ¡£**: æŸ¥çœ‹é¡¹ç›® README è·å–æ›´å¤šä¿¡æ¯

## ğŸ™ è‡´è°¢
æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œç”¨æˆ·çš„åé¦ˆä¸æ”¯æŒï¼

---

### ğŸ“„ æŠ€æœ¯ä¿¡æ¯
- **æ¡†æ¶**: .NET 8.0 WPF
- **æ„å»ºç³»ç»Ÿ**: GitHub Actions
- **ä»£ç ä»“åº“**: https://github.com/${{ github.repository }}
- **è®¸å¯è¯**: æŸ¥çœ‹é¡¹ç›® LICENSE æ–‡ä»¶

### ğŸ”’ å®‰å…¨è¯´æ˜
- ä¸æ”¶é›†ç”¨æˆ·ä¸ªäººä¿¡æ¯
- æ‰€æœ‰é…ç½®ä¿å­˜åœ¨æœ¬åœ°
- å¼€æºä»£ç å¯å®¡è®¡

---

**ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå‘å¸ƒ**
**â­ å¦‚æœå–œæ¬¢è¿™ä¸ªé¡¹ç›®ï¼Œè¯·ç»™ä¸ª Starï¼**
"@
        
        $releaseNotes | Out-File -FilePath "./publish/RELEASE_NOTES.md" -Encoding UTF8
        echo "âœ… å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ"
        
    # 10. åˆ›å»º GitHub Release
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: ${{ env.PROJECT_NAME }} v${{ env.VERSION }}
        body_path: ./publish/RELEASE_NOTES.md
        prerelease: false
        draft: false
        generate_release_notes: false
        files: |
          ./publish/${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip
          ./publish/RELEASE_NOTES.md
        
    # 11. éªŒè¯ Release
    - name: Verify release
      run: |
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG_NAME }}"
        echo "ğŸ“¦ ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip"
        echo "ğŸ·ï¸  æ ‡ç­¾: ${{ env.TAG_NAME }}"
        echo "ğŸ“Š ç‰ˆæœ¬: ${{ env.VERSION }}"
        
    # 12. ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-v2.0.0
        path: |
          ./publish/
        retention-days: 90
