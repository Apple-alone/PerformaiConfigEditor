name: Build and Release WPF Application

on:
  push:
    tags: ['v*.*.*', 'v*.*.*-*']
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号 (例如: 1.0.0)'
        required: true
        default: '1.0.0'
      prerelease:
        description: '是否为预发布版本'
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'
  PROJECT_NAME: 'Performai-Config-Editor'
  
jobs:
  build:
    name: Build Application
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Auto format code before build
      run: |
        # 自动格式化代码
        dotnet format --verbosity normal
        echo "Code formatting completed"
        
    - name: Determine Version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          # 从标签获取版本
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
        else
          # 手动触发，使用输入版本
          VERSION="${{ github.event.inputs.version }}"
        fi
        
        # 清理版本号
        VERSION=$(echo $VERSION | sed 's/^v//')
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        echo "Version: $VERSION"
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build application
      run: |
        dotnet build --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          -p:AssemblyVersion=${{ env.VERSION }} `
          --no-restore
        
    - name: Publish application
      run: |
        # 创建发布目录
        New-Item -ItemType Directory -Path "./artifacts" -Force
        
        # 发布应用程序
        dotnet publish --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          -p:AssemblyVersion=${{ env.VERSION }} `
          --output "./artifacts/${{ env.PROJECT_NAME }}" `
          --no-restore
        
        # 创建ZIP包
        $zipName = "${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip"
        Compress-Archive -Path "./artifacts/${{ env.PROJECT_NAME }}/*" `
          -DestinationPath "./artifacts/$zipName" `
          -Force
        
        echo "Build completed successfully"
        echo "ZIP file: $zipName"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          ./artifacts/
        retention-days: 90
        
  create-release:
    name: Create Release
    needs: [build]
    runs-on: windows-latest
    if: success()
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: ./release-files
        
    - name: Setup release info
      id: release_info
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${{ github.ref_name }}"
          # 检查是否为预发布版本
          if [[ "$TAG_NAME" == *"-alpha"* || "$TAG_NAME" == *"-beta"* || "$TAG_NAME" == *"-rc"* ]]; then
            PRERELEASE="true"
          else
            PRERELEASE="false"
          fi
        else
          TAG_NAME="v${{ github.event.inputs.version }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"
        fi
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        name: ${{ env.PROJECT_NAME }} ${{ steps.release_info.outputs.tag_name }}
        prerelease: ${{ steps.release_info.outputs.prerelease == 'true' }}
        draft: false
        generate_release_notes: true
        files: |
          ./release-files/${{ env.PROJECT_NAME }}-*.zip
