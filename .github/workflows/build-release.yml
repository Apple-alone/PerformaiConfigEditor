name: Build and Release

on:
  push:
    tags: ['v*.*.*', 'v*.*.*-*']
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·'
        required: true
        default: '2.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'
  PROJECT_NAME: 'Performai-Config-Editor'
  
jobs:
  locate-project:
    name: Locate Project Files
    runs-on: windows-latest
    outputs:
      project_path: ${{ steps.find-project.outputs.project_path }}
      project_name: ${{ steps.find-project.outputs.project_name }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Find project file
      id: find-project
      run: |
        echo "æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶..."
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        
        if ($csprojFiles.Count -eq 0) {
          echo "é”™è¯¯: æœªæ‰¾åˆ°.csprojæ–‡ä»¶"
          exit 1
        }
        
        $projectFile = $csprojFiles[0]
        $relativePath = $projectFile.FullName.Substring($PWD.Path.Length + 1)
        $projectName = $projectFile.BaseName
        
        echo "é¡¹ç›®æ–‡ä»¶: $relativePath"
        echo "é¡¹ç›®åç§°: $projectName"
        
        echo "project_path=$relativePath" >> $GITHUB_OUTPUT
        echo "project_name=$projectName" >> $GITHUB_OUTPUT
        
  build:
    name: Build Application
    runs-on: windows-latest
    needs: locate-project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Display project info
      run: |
        echo "é¡¹ç›®è·¯å¾„: ${{ needs.locate-project.outputs.project_path }}"
        echo "é¡¹ç›®åç§°: ${{ needs.locate-project.outputs.project_name }}"
        
    - name: Auto format code
      run: |
        echo "æ ¼å¼åŒ–ä»£ç ..."
        dotnet format --verbosity minimal
        
    - name: Determine Version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        
        VERSION=$(echo $VERSION | sed 's/^v//')
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "æž„å»ºç‰ˆæœ¬: $VERSION"
        
    - name: Restore dependencies
      run: |
        echo "æ¢å¤ä¾èµ–..."
        dotnet restore "${{ needs.locate-project.outputs.project_path }}"
        
    - name: Build application
      run: |
        echo "æž„å»ºåº”ç”¨ç¨‹åº..."
        dotnet build "${{ needs.locate-project.outputs.project_path }}" --configuration ${{ env.CONFIGURATION }} -p:Version=${{ env.VERSION }} -p:FileVersion=${{ env.VERSION }} --no-restore
        
    - name: Publish application
      run: |
        echo "å‘å¸ƒåº”ç”¨ç¨‹åº..."
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        $artifactsDir = "./artifacts"
        $outputDir = "$artifactsDir/${{ env.PROJECT_NAME }}"
        New-Item -ItemType Directory -Path $outputDir -Force
        
        # å‘å¸ƒåº”ç”¨ç¨‹åº
        dotnet publish "${{ needs.locate-project.outputs.project_path }}" --configuration ${{ env.CONFIGURATION }} -p:Version=${{ env.VERSION }} -p:FileVersion=${{ env.VERSION }} --output $outputDir --no-restore
        
        # æ£€æŸ¥å‘å¸ƒç»“æžœ
        if ($LASTEXITCODE -eq 0) {
          echo "âœ… å‘å¸ƒæˆåŠŸ"
        } else {
          echo "âŒ å‘å¸ƒå¤±è´¥"
          exit 1
        }
        
        # åˆ›å»ºZIPåŒ…
        $zipName = "${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip"
        Compress-Archive -Path "$outputDir/*" -DestinationPath "$artifactsDir/$zipName" -Force
        
        echo "ðŸ“¦ ZIPæ–‡ä»¶: $zipName"
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        $exeFiles = Get-ChildItem $outputDir -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          echo "å¯æ‰§è¡Œæ–‡ä»¶:"
          foreach ($exe in $exeFiles) {
            $sizeKB = [math]::Round($exe.Length/1KB, 2)
            echo "  - $($exe.Name) (${sizeKB} KB)"
          }
        }
        
        $allFiles = Get-ChildItem $outputDir -File -Recurse
        if ($allFiles.Count -gt 0) {
          $totalSize = ($allFiles | Measure-Object -Property Length -Sum).Sum
          $totalSizeMB = [math]::Round($totalSize/1MB, 2)
          echo "æ–‡ä»¶æ€»æ•°: $($allFiles.Count)"
          echo "æ€»å¤§å°: ${totalSizeMB} MB"
        }
        
    - name: Create release notes
      run: |
        # åˆ›å»ºç®€å•çš„å‘å¸ƒè¯´æ˜Ž
        $releaseNotes = @"
# ${{ env.PROJECT_NAME }} ${{ env.VERSION }}

## ç³»ç»Ÿè¦æ±‚
- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
- [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)

## å®‰è£…è¯´æ˜Ž
1. ä¸‹è½½å¹¶è§£åŽ‹ ZIP æ–‡ä»¶
2. è¿è¡Œ `${{ needs.locate-project.outputs.project_name }}.exe`

## æ–‡ä»¶ä¿¡æ¯
- æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- æž„å»ºç¼–å·: ${{ github.run_number }}
- é¡¹ç›®åç§°: ${{ needs.locate-project.outputs.project_name }}

## éªŒè¯
å¯åŠ¨ç¨‹åºåŽï¼Œæ£€æŸ¥çŠ¶æ€æ æ˜¾ç¤ºçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚

---
*è‡ªåŠ¨æž„å»ºäºŽ GitHub Actions*
"@
        
        $releaseNotes | Out-File -FilePath "./artifacts/RELEASE_NOTES.md" -Encoding UTF8
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: ./artifacts/
        
  create-release:
    name: Create GitHub Release
    runs-on: windows-latest
    needs: [build]
    if: success()
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./release
        
    - name: Setup release info
      id: release_info
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" == *"-alpha"* || "$TAG_NAME" == *"-beta"* || "$TAG_NAME" == *"-rc"* ]]; then
            PRERELEASE="true"
          else
            PRERELEASE="false"
          fi
        else
          TAG_NAME="v${{ github.event.inputs.version }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"
        fi
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        name: ${{ env.PROJECT_NAME }} ${{ steps.release_info.outputs.tag_name }}
        body_path: ./release/RELEASE_NOTES.md
        prerelease: ${{ steps.release_info.outputs.prerelease == 'true' }}
        draft: false
        files: |
          ./release/${{ env.PROJECT_NAME }}-*.zip
          ./release/RELEASE_NOTES.md
