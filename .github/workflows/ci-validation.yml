name: CI Validation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    name: Validate Code
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Find project files
      run: |
        echo "=== æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶ ==="
        Get-ChildItem -Path . -Recurse -Filter "*.csproj" | ForEach-Object {
          echo "æ‰¾åˆ°é¡¹ç›®: $($_.FullName)"
        }
        
    - name: Restore dependencies
      run: |
        echo "æ¢å¤ä¾èµ–..."
        dotnet restore
        
    - name: Build solution
      run: |
        echo "æ„å»ºè§£å†³æ–¹æ¡ˆ..."
        dotnet build --configuration Release
        
  test-publish:
    name: Test Publish
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Find project file
      id: find-project
      run: |
        echo "æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶..."
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        
        if ($csprojFiles.Count -eq 0) {
          echo "é”™è¯¯: æœªæ‰¾åˆ°.csprojæ–‡ä»¶"
          Get-ChildItem -Path . -Recurse | Format-Table Name, FullName
          exit 1
        }
        
        # ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„é¡¹ç›®æ–‡ä»¶
        $projectFile = $csprojFiles[0].FullName
        echo "é¡¹ç›®æ–‡ä»¶: $projectFile"
        echo "PROJECT_FILE=$projectFile" >> $env:GITHUB_ENV
        
    - name: Test publish
      run: |
        echo "=== æµ‹è¯•å‘å¸ƒæµç¨‹ ==="
        echo "é¡¹ç›®æ–‡ä»¶: $env:PROJECT_FILE"
        
        # åˆ›å»ºä¸´æ—¶è¾“å‡ºç›®å½•
        $outputDir = "./test-publish-output"
        New-Item -ItemType Directory -Path $outputDir -Force
        
        # æµ‹è¯•å‘å¸ƒ
        echo "æ‰§è¡Œå‘å¸ƒå‘½ä»¤..."
        dotnet publish "$env:PROJECT_FILE" --configuration Release --output $outputDir -p:Version=1.0.0 --verbosity minimal
        
        # æ£€æŸ¥å‘å¸ƒç»“æœ
        if ($LASTEXITCODE -eq 0) {
          echo "âœ… å‘å¸ƒæˆåŠŸ"
        } else {
          echo "âŒ å‘å¸ƒå¤±è´¥"
          exit 1
        }
        
        # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        echo ""
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        $files = Get-ChildItem $outputDir -File
        if ($files.Count -gt 0) {
          $files | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
        } else {
          echo "æœªæ‰¾åˆ°æ–‡ä»¶"
        }
        
        # æ£€æŸ¥ä¸»è¦ç¨‹åºé›†
        $exeFiles = Get-ChildItem $outputDir -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          echo ""
          echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶:"
          foreach ($exe in $exeFiles) {
            $sizeKB = [math]::Round($exe.Length/1KB, 2)
            echo "  - $($exe.Name) (${sizeKB} KB)"
          }
        } else {
          echo ""
          echo "âš ï¸ æœªæ‰¾åˆ°.exeæ–‡ä»¶ï¼Œæ£€æŸ¥.dllæ–‡ä»¶..."
          $dllFiles = Get-ChildItem $outputDir -Filter "*.dll" | Select-Object -First 5
          if ($dllFiles.Count -gt 0) {
            echo "æ‰¾åˆ°DLLæ–‡ä»¶:"
            foreach ($dll in $dllFiles) {
              echo "  - $($dll.Name)"
            }
          } else {
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•è¾“å‡ºæ–‡ä»¶"
          }
        }
        
        # æ˜¾ç¤ºæ–‡ä»¶æ€»æ•°å’Œæ€»å¤§å°
        $allFiles = Get-ChildItem $outputDir -File -Recurse
        if ($allFiles.Count -gt 0) {
          $totalSize = ($allFiles | Measure-Object -Property Length -Sum).Sum
          $totalSizeKB = [math]::Round($totalSize/1KB, 2)
          echo ""
          echo "ğŸ“Š ç»Ÿè®¡:"
          echo "  æ–‡ä»¶æ€»æ•°: $($allFiles.Count)"
          echo "  æ€»å¤§å°: ${totalSizeKB} KB"
        }
        
        # æ¸…ç†
        Remove-Item -Path $outputDir -Recurse -Force -ErrorAction SilentlyContinue
        
    - name: Test with different configurations
      run: |
        echo "=== æµ‹è¯•ä¸åŒé…ç½® ==="
        
        # æµ‹è¯•Debugé…ç½®
        echo ""
        echo "æµ‹è¯•Debugé…ç½®..."
        dotnet build "$env:PROJECT_FILE" --configuration Debug
        
        # æµ‹è¯•Releaseé…ç½®
        echo ""
        echo "æµ‹è¯•Releaseé…ç½®..."
        dotnet build "$env:PROJECT_FILE" --configuration Release
        
        echo ""
        echo "âœ… æ‰€æœ‰é…ç½®æµ‹è¯•é€šè¿‡"
