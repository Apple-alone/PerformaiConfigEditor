name: Build and Release

on:
  push:
    tags: ['v*.*.*', 'v*.*.*-*']
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '2.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: 'Release'
  PROJECT_NAME: 'Performai-Config-Editor'
  
jobs:
  build:
    name: Build Application
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Auto format code
      run: |
        # è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
        dotnet format --verbosity minimal
        echo "Code formatted"
        
    - name: Determine Version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        
        VERSION=$(echo $VERSION | sed 's/^v//')
        
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        echo "Building version: $VERSION"
        
    - name: Restore dependencies
      run: |
        dotnet restore "Performai Config Editor.sln"
        
    - name: Build application
      run: |
        dotnet build "Performai Config Editor.sln" `
          --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          -p:AssemblyVersion=${{ env.VERSION }} `
          --no-restore
        
    - name: Publish application
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Path "./artifacts" -Force
        
        # å‘å¸ƒåº”ç”¨ç¨‹åº
        dotnet publish "Performai Config Editor.csproj" `
          --configuration ${{ env.CONFIGURATION }} `
          -p:Version=${{ env.VERSION }} `
          -p:FileVersion=${{ env.VERSION }} `
          --output "./artifacts/${{ env.PROJECT_NAME }}" `
          --no-restore
        
        # åˆ›å»ºZIPåŒ…
        $zipName = "${{ env.PROJECT_NAME }}-${{ env.VERSION }}.zip"
        Compress-Archive -Path "./artifacts/${{ env.PROJECT_NAME }}/*" `
          -DestinationPath "./artifacts/$zipName" `
          -Force
        
        echo "âœ… Build completed"
        echo "ðŸ“¦ ZIP file: $zipName"
        
    - name: Create simple release notes
      run: |
        # åˆ›å»ºç®€å•çš„å‘å¸ƒè¯´æ˜Ž
        $releaseNotes = @"
# ${{ env.PROJECT_NAME }} ${{ env.VERSION }}

## ç³»ç»Ÿè¦æ±‚
- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
- [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)

## å®‰è£…è¯´æ˜Ž
1. ä¸‹è½½å¹¶è§£åŽ‹ ZIP æ–‡ä»¶
2. è¿è¡Œ `${{ env.PROJECT_NAME }}.exe`

## æ–‡ä»¶åˆ—è¡¨
- `${{ env.PROJECT_NAME }}.exe` - ä¸»ç¨‹åº
- å„ç§ DLL æ–‡ä»¶ - ä¾èµ–åº“
- `*.config` - é…ç½®æ–‡ä»¶

## éªŒè¯
å¯åŠ¨ç¨‹åºåŽï¼Œæ£€æŸ¥çŠ¶æ€æ æ˜¾ç¤ºçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚

---
*Build: ${{ github.run_number }} | Date: $(Get-Date -Format 'yyyy-MM-dd')*
"@
        
        $releaseNotes | Out-File -FilePath "./artifacts/RELEASE_NOTES.md" -Encoding UTF8
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ./artifacts/
        retention-days: 90
        
  create-release:
    name: Create Release
    needs: [build]
    runs-on: windows-latest
    if: success()
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./release
        
    - name: Setup release info
      id: release_info
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" == *"-alpha"* || "$TAG_NAME" == *"-beta"* || "$TAG_NAME" == *"-rc"* ]]; then
            PRERELEASE="true"
          else
            PRERELEASE="false"
          fi
        else
          TAG_NAME="v${{ github.event.inputs.version }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"
        fi
        
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
        
        echo "Creating release for tag: $TAG_NAME"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        name: ${{ env.PROJECT_NAME }} ${{ steps.release_info.outputs.tag_name }}
        body_path: ./release/RELEASE_NOTES.md
        prerelease: ${{ steps.release_info.outputs.prerelease == 'true' }}
        draft: false
        files: |
          ./release/${{ env.PROJECT_NAME }}-*.zip
