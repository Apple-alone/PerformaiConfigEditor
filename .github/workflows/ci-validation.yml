name: CI Validation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  validate:
    name: Validate Code
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Find project files
      run: |
        echo "=== æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶ ==="
        Get-ChildItem -Path . -Recurse -Filter "*.csproj" | ForEach-Object {
          echo "Found project: $($_.FullName)"
          echo "Relative path: $($_.FullName.Substring($PWD.Path.Length + 1))"
        }
        
        echo "`n=== å½“å‰ç›®å½•ç»“æ„ ==="
        Get-ChildItem -Path . -Recurse | Where-Object { $_.PSIsContainer } | Select-Object FullName | ForEach-Object {
          echo "$($_.FullName)"
        }
        
    - name: Restore dependencies
      run: |
        echo "Restoring dependencies..."
        # æŸ¥æ‰¾å¹¶æ¢å¤æ‰€æœ‰é¡¹ç›®
        Get-ChildItem -Path . -Recurse -Filter "*.csproj" | ForEach-Object {
          echo "Restoring: $($_.Name)"
          dotnet restore $_.FullName
        }
        
    - name: Build solution
      run: |
        echo "Building solution..."
        # æŸ¥æ‰¾è§£å†³æ–¹æ¡ˆæˆ–é¡¹ç›®æ–‡ä»¶
        $slnFiles = Get-ChildItem -Path . -Recurse -Filter "*.sln"
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        
        if ($slnFiles.Count -gt 0) {
          echo "Found solution file: $($slnFiles[0].Name)"
          dotnet build $slnFiles[0].FullName --configuration Release
        } elseif ($csprojFiles.Count -gt 0) {
          echo "Found project file: $($csprojFiles[0].Name)"
          dotnet build $csprojFiles[0].FullName --configuration Release
        } else {
          echo "Error: No .sln or .csproj files found"
          exit 1
        }
        
  test-publish:
    name: Test Publish
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Find and display project structure
      run: |
        echo "=== é¡¹ç›®ç»“æ„åˆ†æ ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $PWD"
        echo "`næ‰€æœ‰æ–‡ä»¶:"
        Get-ChildItem -Path . -Recurse -File | Select-Object -First 20 | ForEach-Object {
          echo "  $($_.FullName.Substring($PWD.Path.Length + 1))"
        }
        
        echo "`n=== æŸ¥æ‰¾.csprojæ–‡ä»¶ ==="
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        if ($csprojFiles.Count -eq 0) {
          echo "é”™è¯¯: æœªæ‰¾åˆ°.csprojæ–‡ä»¶"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          Get-ChildItem -Path .
          exit 1
        }
        
        foreach ($file in $csprojFiles) {
          echo "æ‰¾åˆ°é¡¹ç›®æ–‡ä»¶: $($file.FullName)"
          echo "ç›¸å¯¹è·¯å¾„: $($file.FullName.Substring($PWD.Path.Length + 1))"
        }
        
        # ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„.csprojæ–‡ä»¶
        $projectFile = $csprojFiles[0].FullName
        echo "`nå°†ä½¿ç”¨é¡¹ç›®æ–‡ä»¶: $projectFile"
        echo "PROJECT_FILE=$projectFile" >> $env:GITHUB_ENV
        
    - name: Test publish
      run: |
        echo "=== æµ‹è¯•å‘å¸ƒæµç¨‹ ==="
        echo "é¡¹ç›®æ–‡ä»¶: $env:PROJECT_FILE"
        
        # åˆ›å»ºä¸´æ—¶è¾“å‡ºç›®å½•
        $outputDir = "./test-publish-output"
        New-Item -ItemType Directory -Path $outputDir -Force
        
        # æµ‹è¯•å‘å¸ƒ
        echo "æ‰§è¡Œå‘å¸ƒå‘½ä»¤..."
        dotnet publish "$env:PROJECT_FILE" `
          --configuration Release `
          --output $outputDir `
          -p:Version=1.0.0 `
          --verbosity minimal
        
        if ($LASTEXITCODE -eq 0) {
          echo "âœ… å‘å¸ƒæˆåŠŸ"
        else {
          echo "âŒ å‘å¸ƒå¤±è´¥"
          exit 1
        }
        
        # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        echo "`n=== ç”Ÿæˆçš„æ–‡ä»¶ ==="
        Get-ChildItem $outputDir -File | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
        
        # æ£€æŸ¥ä¸»è¦ç¨‹åºé›†
        $exeFiles = Get-ChildItem $outputDir -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          echo "`nâœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶:"
          foreach ($exe in $exeFiles) {
            echo "  - $($exe.Name) ($([math]::Round($exe.Length/1KB, 2)) KB)"
          }
        } else {
          echo "`nâš ï¸ æœªæ‰¾åˆ°.exeæ–‡ä»¶ï¼Œæ£€æŸ¥.dllæ–‡ä»¶..."
          $dllFiles = Get-ChildItem $outputDir -Filter "*.dll" | Select-Object -First 5
          if ($dllFiles.Count -gt 0) {
            echo "æ‰¾åˆ°DLLæ–‡ä»¶:"
            foreach ($dll in $dllFiles) {
              echo "  - $($dll.Name)"
            }
          } else {
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•è¾“å‡ºæ–‡ä»¶"
          }
        }
        
        # æ˜¾ç¤ºæ–‡ä»¶æ€»æ•°å’Œæ€»å¤§å°
        $allFiles = Get-ChildItem $outputDir -File -Recurse
        $totalSize = ($allFiles | Measure-Object -Property Length -Sum).Sum
        echo "`nğŸ“Š ç»Ÿè®¡:"
        echo "  æ–‡ä»¶æ€»æ•°: $($allFiles.Count)"
        echo "  æ€»å¤§å°: $([math]::Round($totalSize/1KB, 2)) KB"
        
        # æ¸…ç†
        Remove-Item -Path $outputDir -Recurse -Force -ErrorAction SilentlyContinue
        
    - name: Test with different configurations
      run: |
        echo "=== æµ‹è¯•ä¸åŒé…ç½® ==="
        
        # æµ‹è¯•Debugé…ç½®
        echo "`næµ‹è¯•Debugé…ç½®..."
        dotnet build "$env:PROJECT_FILE" --configuration Debug
        
        # æµ‹è¯•Releaseé…ç½®
        echo "`næµ‹è¯•Releaseé…ç½®..."
        dotnet build "$env:PROJECT_FILE" --configuration Release
        
        echo "âœ… æ‰€æœ‰é…ç½®æµ‹è¯•é€šè¿‡"
