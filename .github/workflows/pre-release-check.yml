name: Pre-release Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    name: Validate for v2.0.0 Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x'
        
    - name: Check version consistency
      run: |
        echo "ğŸ” æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§..."
        
        # æ£€æŸ¥ CHANGELOG.md
        if (Test-Path "CHANGELOG.md") {
          $changelogContent = Get-Content "CHANGELOG.md" -Raw
          if ($changelogContent -match "\[2\.0\.0\]") {
            echo "âœ… CHANGELOG.md åŒ…å« v2.0.0"
          } else {
            echo "âŒ CHANGELOG.md æœªåŒ…å« v2.0.0"
          }
        }
        
        # æ£€æŸ¥é¡¹ç›®æ–‡ä»¶
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        if ($csprojFiles.Count -gt 0) {
          $csprojContent = Get-Content $csprojFiles[0].FullName -Raw
          echo "ğŸ“¦ é¡¹ç›®æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
        }
        
    - name: Build test
      run: |
        echo "ğŸ”¨ æ„å»ºæµ‹è¯•..."
        dotnet build --configuration Release -p:Version=2.0.0
        
        if ($LASTEXITCODE -eq 0) {
          echo "âœ… æ„å»ºæµ‹è¯•é€šè¿‡"
        } else {
          echo "âŒ æ„å»ºæµ‹è¯•å¤±è´¥"
          exit 1
        }
        
    - name: Publish test
      run: |
        echo "ğŸš€ å‘å¸ƒæµ‹è¯•..."
        
        $csprojFiles = Get-ChildItem -Path . -Recurse -Filter "*.csproj"
        if ($csprojFiles.Count -eq 0) {
          echo "è·³è¿‡å‘å¸ƒæµ‹è¯•"
          exit 0
        }
        
        $projectFile = $csprojFiles[0].FullName
        $outputDir = "./test-v2.0.0"
        
        dotnet publish $projectFile --configuration Release -p:Version=2.0.0 --output $outputDir
        
        if ($LASTEXITCODE -eq 0) {
          echo "âœ… å‘å¸ƒæµ‹è¯•é€šè¿‡"
          
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          $exeFiles = Get-ChildItem $outputDir -Filter "*.exe"
          if ($exeFiles.Count -gt 0) {
            echo "ğŸ“„ ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶:"
            foreach ($exe in $exeFiles) {
              echo "  - $($exe.Name)"
            }
          }
          
          Remove-Item -Path $outputDir -Recurse -Force
        } else {
          echo "âŒ å‘å¸ƒæµ‹è¯•å¤±è´¥"
          exit 1
        }
        
    - name: Ready for release
      run: |
        echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
        echo ""
        echo "ğŸ“‹ å‘å¸ƒæ£€æŸ¥æ¸…å•:"
        echo "  âœ… ä»£ç å·²æäº¤åˆ° main/master åˆ†æ”¯"
        echo "  âœ… æ„å»ºæµ‹è¯•é€šè¿‡"
        echo "  âœ… å‘å¸ƒæµ‹è¯•é€šè¿‡"
        echo "  âœ… CHANGELOG å·²æ›´æ–°"
        echo ""
        echo "ğŸš€ å‡†å¤‡å‘å¸ƒ v2.0.0:"
        echo "  1. åˆ›å»ºæ ‡ç­¾: git tag v2.0.0"
        echo "  2. æ¨é€æ ‡ç­¾: git push origin v2.0.0"
        echo "  3. æŸ¥çœ‹ GitHub Actions è‡ªåŠ¨å‘å¸ƒ"
